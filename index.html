<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050507">
    <meta name="description" content="Scientific Nexus Research Terminal - Advanced Physics & Strategy Simulations">
    
    <link rel="manifest" href="/manifest.json">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>Scientific Nexus | Research Terminal 2.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { 
            --cyan: #00f2ff; 
            --cyan-dim: rgba(0, 242, 255, 0.1);
            --cyan-glass: rgba(0, 242, 255, 0.05);
            --purple: #bc13fe; 
            --dark: #050507; 
            --panel: #0f0f13;
            --panel-border: rgba(255,255,255,0.08);
            --header-h: 70px;
            --danger: #ff4444;
            --success: #00ff88;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --font-main: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            --font-mono: 'Courier New', Courier, monospace;
        }
        
        * { 
            box-sizing: border-box; outline: none; 
            -webkit-tap-highlight-color: transparent; 
        }

        body { 
            background: var(--dark); color: var(--text-main); font-family: var(--font-main); 
            margin: 0; overflow-x: hidden; overscroll-behavior-y: none;
        }

        /* --- CRT & ATMOSPHERE EFFECTS --- */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 9990;
        }

        .scanline {
            width: 100%; height: 100px; z-index: 9991;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0, 242, 255, 0.03) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1; position: fixed; bottom: 100%; left: 0;
            pointer-events: none; animation: scanline 10s linear infinite;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100px; } }

        /* --- LOADER --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark);
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        #loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .spinner {
            width: 50px; height: 50px; border: 2px solid var(--cyan-dim); 
            border-top: 2px solid var(--cyan); border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- NAVIGATION --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5%; background: rgba(5,5,7,0.9); backdrop-filter: blur(20px);
            position: fixed; width: 100%; top: 0; z-index: 5000; border-bottom: 1px solid var(--panel-border);
            height: var(--header-h);
        }
        .logo { 
            font-weight: 700; color: var(--cyan); letter-spacing: 2px; font-size: 1rem; 
            text-transform: uppercase; display: flex; align-items: center; gap: 12px; cursor: pointer;
        }
        .user-nav { display: flex; align-items: center; gap: 15px; }
        
        .auth-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--panel-border); color: white;
            padding: 8px 18px; border-radius: 4px; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 10px; font-size: 0.75rem; letter-spacing: 1px;
            text-transform: uppercase;
        }
        .auth-btn:hover { border-color: var(--cyan); background: var(--cyan-glass); }
        .user-avatar { width: 32px; height: 32px; border-radius: 4px; border: 1px solid var(--cyan-dim); object-fit: cover; }

        /* --- LAYOUT & GRID SYSTEM --- */
        #app-content { 
            padding-top: var(--header-h); min-height: 100vh; 
            display: flex; flex-direction: column; padding-bottom: 100px;
        }

        .reveal-on-scroll {
            opacity: 0; transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .reveal-on-scroll.reveal { opacity: 1; transform: translateY(0); }

        .container { max-width: 1600px; width: 92%; margin: 0 auto; }

        .hero {
            padding: 60px 0 40px; text-align: center;
            background: radial-gradient(circle at 50% -20%, #111119 0%, var(--dark) 70%);
            border-bottom: 1px solid var(--panel-border); margin-bottom: 30px;
        }
        .hero h1 {
            font-size: clamp(1.8rem, 4vw, 3rem); margin: 0 0 10px;
            color: white; text-transform: uppercase; letter-spacing: 4px; font-weight: 300;
        }
        .hero p { color: var(--cyan); font-size: 0.85rem; letter-spacing: 2px; text-transform: uppercase; opacity: 0.7; }

        /* --- CONTROLS --- */
        .search-bar {
            background: var(--panel); border: 1px solid var(--panel-border); border-radius: 4px;
            padding: 0 20px; display: flex; align-items: center; gap: 15px; margin-bottom: 30px;
            height: 55px; position: relative; overflow: hidden; transition: 0.3s;
        }
        .search-bar:focus-within { border-color: var(--cyan); box-shadow: 0 0 20px var(--cyan-dim); }
        .search-bar input { 
            background: transparent; border: none; color: white; width: 100%; height: 100%;
            font-size: 1rem; letter-spacing: 1px;
        }
        
        .categories { 
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; 
            scrollbar-width: none; -webkit-overflow-scrolling: touch; margin-bottom: 30px;
        }
        .categories::-webkit-scrollbar { display: none; }
        
        .cat-btn {
            background: var(--panel); color: var(--text-dim); border: 1px solid var(--panel-border); 
            padding: 10px 20px; border-radius: 2px; white-space: nowrap; cursor: pointer; 
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
        }
        .cat-btn.active, .cat-btn:hover { 
            background: var(--cyan-glass); color: var(--cyan); border-color: var(--cyan); 
        }

        /* --- GAME GRID --- */
        .grid { 
            display: grid; gap: 20px;
            /* Adaptive Grid: Scales from mobile to 4K */
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); 
            width: 100%;
        }

        .card { 
            background: var(--panel); border: 1px solid var(--panel-border); 
            border-radius: 4px; overflow: hidden; position: relative; cursor: pointer; 
            transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s;
            display: flex; flex-direction: column;
        }
        .card:hover { 
            transform: translateY(-4px); border-color: var(--cyan); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        .thumb { 
            height: 160px; width: 100%; object-fit: cover; 
            opacity: 0.8; transition: opacity 0.3s; background: #000; 
        }
        .card:hover .thumb { opacity: 1; }
        .card-body { padding: 15px; border-top: 1px solid var(--panel-border); flex: 1; }
        .card-title { 
            margin: 0; font-size: 0.9rem; color: white; white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.5px; 
        }
        .card-cat { 
            color: var(--cyan); font-size: 0.65rem; margin-top: 6px; 
            display: block; text-transform: uppercase; letter-spacing: 1px; 
        }

        /* --- GAME VIEWER --- */
        #game-viewer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--dark); z-index: 6000; overflow-y: auto; 
            display: none; opacity: 0; transition: opacity 0.3s ease;
        }
        #game-viewer.active { opacity: 1; }

        .gv-nav {
            height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
            border-bottom: 1px solid var(--panel-border); background: var(--panel);
        }
        
        .gv-stage { width: 100%; max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        .game-frame-wrapper {
            position: relative; width: 100%; padding-top: 56.25%; 
            background: black; border: 1px solid var(--panel-border); 
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .game-loader-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #000; display: flex; align-items: center; justify-content: center; z-index: 5;
        }
        .game-frame-wrapper iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; z-index: 10;
        }

        /* --- ADVERTISING --- */
        .ad-uplink-container {
            max-width: 1200px; margin: 0 auto 30px; padding: 20px;
            background: var(--panel); border: 1px dashed var(--panel-border);
            text-align: center; width: 92%;
        }
        .ad-label {
            font-size: 0.6rem; color: #444; text-transform: uppercase;
            letter-spacing: 2px; margin-bottom: 10px; display: block;
        }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 7000; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }

        .modal-box { 
            background: #0e0e12; padding: 30px; border: 1px solid var(--panel-border); 
            width: 100%; max-width: 450px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border-left: 2px solid var(--cyan);
        }
        .modal-box.large { max-width: 800px; max-height: 85vh; overflow-y: auto; }

        .modal-input {
            width: 100%; padding: 14px; background: #15151a; border: 1px solid var(--panel-border); 
            color: white; border-radius: 2px; margin-bottom: 15px; font-size: 1rem; color: var(--cyan);
            font-family: var(--font-mono);
        }
        .action-btn {
            background: var(--cyan); color: black; border: none; padding: 14px; 
            width: 100%; cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- MODERN PROFILE CARD --- */
        .pro-profile-card {
            width: 100%; background: linear-gradient(145deg, #0e0e12, #08080a);
            border: 1px solid var(--panel-border); padding: 0;
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        .pro-header {
            padding: 30px; display: flex; align-items: center; gap: 25px;
            border-bottom: 1px solid var(--panel-border);
            background: linear-gradient(to right, rgba(0,242,255,0.02), transparent);
        }

        .pro-avatar-container {
            position: relative; width: 80px; height: 80px;
        }
        
        .pro-avatar {
            width: 100%; height: 100%; object-fit: cover; border-radius: 4px;
            border: 1px solid var(--cyan); 
            box-shadow: 0 0 15px var(--cyan-dim);
            animation: avatarPulse 3s infinite alternate;
        }
        @keyframes avatarPulse { 0% { box-shadow: 0 0 10px var(--cyan-dim); } 100% { box-shadow: 0 0 25px rgba(0,242,255,0.3); } }

        .pro-identity h2 { margin: 0; font-size: 1.4rem; color: white; letter-spacing: 1px; text-transform: uppercase; }
        .pro-tag { 
            display: inline-block; font-size: 0.7rem; color: var(--cyan); 
            border: 1px solid var(--cyan-dim); padding: 4px 8px; margin-top: 8px;
            letter-spacing: 1px; text-transform: uppercase; background: var(--cyan-glass);
        }

        .pro-stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; 
            border-bottom: 1px solid var(--panel-border);
        }
        .stat-box {
            padding: 20px; border-right: 1px solid var(--panel-border);
            display: flex; flex-direction: column; gap: 5px;
        }
        .stat-box:last-child { border-right: none; }
        .stat-label { font-size: 0.65rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 0.95rem; color: white; font-family: var(--font-mono); }

        .pro-xp-section { padding: 25px 30px; }
        .xp-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: #aaa; margin-bottom: 10px; text-transform: uppercase; }
        .xp-track {
            height: 4px; background: #222; width: 100%; position: relative; overflow: hidden;
        }
        .xp-progress {
            height: 100%; background: var(--cyan); 
            box-shadow: 0 0 10px var(--cyan); transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pro-actions { padding: 20px; border-top: 1px solid var(--panel-border); }
        .disconnect-btn {
            background: transparent; color: var(--danger); border: 1px solid rgba(255,68,68,0.3);
            width: 100%; padding: 12px; font-size: 0.8rem; text-transform: uppercase;
            cursor: pointer; letter-spacing: 2px; transition: 0.2s;
        }
        .disconnect-btn:hover { background: rgba(255,68,68,0.1); border-color: var(--danger); }

        /* --- SOCIAL/CHAT SYSTEM --- */
        #social-fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; background: var(--panel); border: 1px solid var(--cyan);
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            color: var(--cyan); font-size: 1.4rem; cursor: pointer; z-index: 5000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: transform 0.3s;
        }
        #social-fab:hover { transform: scale(1.1); }
        .fab-badge {
            position: absolute; top: -5px; right: -5px; background: var(--danger); color: white;
            width: 24px; height: 24px; border-radius: 50%; font-size: 0.75rem; 
            display: none; align-items: center; justify-content: center; font-weight: bold;
        }

        #social-panel {
            position: fixed; bottom: 100px; right: 30px; 
            width: 380px; height: 600px; max-height: 70vh; max-width: 90vw;
            background: #0a0a0d; border: 1px solid var(--panel-border);
            z-index: 4999; transform: translateX(120%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
        }
        #social-panel.active { transform: translateX(0); }

        .social-tabs { display: flex; border-bottom: 1px solid var(--panel-border); background: #111; }
        .tab-btn { 
            flex: 1; padding: 15px 0; background: none; border: none; color: #666; cursor: pointer; 
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; 
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active { color: var(--cyan); border-bottom-color: var(--cyan); background: rgba(0, 242, 255, 0.02); }

        .social-body { flex: 1; overflow-y: auto; position: relative; }
        .social-view { display: none; padding: 0; }
        .social-view.active { display: block; }
        
        .friend-item {
            display: flex; align-items: center; gap: 12px; padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; transition: 0.2s;
        }
        .friend-item:hover { background: rgba(255,255,255,0.03); }

        #chat-interface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0d; z-index: 50; display: flex; flex-direction: column;
            transform: translateX(100%); transition: 0.3s ease;
        }
        #chat-interface.open { transform: translateX(0); }
        .chat-header { 
            padding: 15px; background: var(--panel); border-bottom: 1px solid var(--panel-border); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; word-wrap: break-word; }
        .msg.mine { align-self: flex-end; background: var(--cyan); color: black; }
        .msg.theirs { align-self: flex-start; background: #222; color: white; border: 1px solid #333; }
        .chat-input-area { padding: 15px; background: var(--panel); display: flex; gap: 10px; border-top: 1px solid var(--panel-border); }

        /* --- TOASTS --- */
        #nexus-toast-container {
            position: fixed; top: 90px; right: 20px; z-index: 8000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .nexus-toast {
            background: rgba(10, 10, 15, 0.95); border-left: 3px solid var(--cyan);
            border-top: 1px solid #333; border-right: 1px solid #333; border-bottom: 1px solid #333;
            padding: 15px; width: 300px; max-width: 90vw; border-radius: 2px; pointer-events: auto;
            transform: translateX(120%); transition: transform 0.4s; display: flex; gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .nexus-toast.active { transform: translateX(0); }
        .nexus-toast h4 { margin: 0 0 5px; color: white; font-size: 0.85rem; text-transform: uppercase; }
        .nexus-toast p { margin: 0; font-size: 0.8rem; color: #aaa; }

        /* --- FOOTER --- */
        .footer-terminal {
            text-align: center; padding: 40px 20px; margin-top: auto;
            border-top: 1px solid var(--panel-border); font-size: 0.75rem; color: #555;
            background: #08080a;
        }
        .footer-link {
            color: #666; text-decoration: none; border-bottom: 1px solid transparent; transition: 0.2s;
            cursor: pointer; display: inline-block; margin: 0 10px; text-transform: uppercase; letter-spacing: 1px;
        }
        .footer-link:hover { color: var(--cyan); border-color: var(--cyan); }

        /* --- RESPONSIVE MEDIA QUERIES --- */
        @media screen and (max-width: 768px) {
            :root { --header-h: 60px; }
            .hero h1 { font-size: 1.8rem; }
            .container { width: 95%; }
            .grid { grid-template-columns: 1fr; gap: 15px; }
            
            #social-panel { 
                width: 100%; height: 100%; max-height: 100%; max-width: 100%; 
                top: 0; left: 0; bottom: 0; right: 0; border-radius: 0;
                transform: translateY(100%); z-index: 9995;
            }
            #social-panel.active { transform: translateY(0); }
            
            .modal-box { width: 100%; height: 100%; max-width: none; border-radius: 0; border: none; padding: 20px; display: flex; flex-direction: column; justify-content: center; }
            .modal-box.large { justify-content: flex-start; }
            .gv-stage { margin: 10px auto; padding: 0 10px; }
            .game-frame-wrapper { border-radius: 0; }
        }
    </style>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6504872858297214" crossorigin="anonymous"></script>
</head>
<body>

<div class="crt-overlay"></div>
<div class="scanline"></div>

<div id="loader"><div class="spinner"></div></div>
<div id="nexus-toast-container"></div>

<nav>
    <div class="logo" onclick="goHome()">
        <i class="fas fa-atom"></i> <span class="logo-text">Scientific Nexus</span>
    </div>
    <div class="user-nav" id="auth-container">
        <span style="font-size:0.7rem; color:#666; letter-spacing:1px;">SYSTEM BOOT...</span>
    </div>
</nav>

<div id="app-content">
    <div class="hero reveal-on-scroll">
        <div class="container">
            <h1>Research Terminal</h1>
            <p>Advanced Tactical Simulations & Physics Modules</p>
        </div>
    </div>

    <div class="ad-uplink-container reveal-on-scroll">
        <span class="ad-label">Sponsored Uplink Protocol</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6504872858297214"
             data-ad-slot="5786114760"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <div class="container reveal-on-scroll">
        <div class="search-bar">
            <i class="fas fa-search" style="color:var(--text-dim)"></i>
            <input type="text" id="search-input" placeholder="SEARCH DATABASE..." onkeyup="filterGames()">
        </div>
        
        <div class="categories">
            <button class="cat-btn active" onclick="filterCat('All')">All</button>
            <button class="cat-btn" onclick="filterCat('Action')">Action</button>
            <button class="cat-btn" onclick="filterCat('Strategy')">Strategy</button>
            <button class="cat-btn" onclick="filterCat('Physics')">Physics</button>
            <button class="cat-btn" onclick="filterCat('Puzzle')">Puzzle</button>
            <button class="cat-btn" onclick="filterCat('Simulation')">Simulation</button>
            <button class="cat-btn" onclick="filterCat('Arcade')">Arcade</button>
            <button class="cat-btn" onclick="filterCat('Sports & Racing')">Sports</button>
            <button class="cat-btn" onclick="filterCat('Casual')">Casual</button>
            <button class="cat-btn" onclick="filterCat('Educational')">Edu</button>
        </div>

        <div class="grid" id="game-grid"></div>
    </div>
    
    <div class="footer-terminal reveal-on-scroll">
        <div style="margin-bottom: 15px;">SCIENTIFIC NEXUS TERMINAL v2.0 // EST. 2024</div>
        <span class="footer-link" onclick="openProtocols()">NEXUS PROTOCOLS</span>
        <span class="footer-link" onclick="openProtocols()">DATA MANIFEST</span>
        <div style="margin-top: 15px; font-size: 0.65rem; opacity: 0.4;">Optimized for Quantum Processors</div>
    </div>
</div>

<div id="game-viewer">
    <div class="gv-nav">
        <button onclick="closeGame()" style="background:transparent; border:1px solid var(--danger); color:var(--danger); padding:6px 14px; cursor:pointer; font-size:0.7rem; text-transform:uppercase;">
            <i class="fas fa-times"></i> Terminate
        </button>
        <span id="gv-title" style="color:white; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;">Simulation</span>
        <button onclick="toggleFull()" style="background:transparent; border:1px solid #444; color:white; padding:6px 10px; cursor:pointer;">
            <i class="fas fa-expand"></i>
        </button>
    </div>
    
    <div class="gv-stage">
        <div class="game-frame-wrapper" id="gf-wrapper">
            <div class="game-loader-overlay" id="game-loader-ui">
                <div class="spinner"></div>
            </div>
            <iframe id="game-frame" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-pointer-lock" allowfullscreen></iframe>
        </div>
        <div style="margin-top:20px; display:flex; justify-content:space-between; color:#666; font-size:0.8rem; text-transform:uppercase;">
            <span id="gv-cat">Physics Module</span>
            <span style="color:var(--success)">System Optimal</span>
        </div>
    </div>
</div>

<div id="social-fab" onclick="toggleSocialPanel()">
    <i class="fas fa-users"></i>
    <div class="fab-badge" id="global-badge">0</div>
</div>

<div id="social-panel">
    <div id="chat-interface">
        <div class="chat-header">
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:1.1rem; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
            <div style="color:var(--cyan); font-weight:bold; font-size:0.9rem;" id="chat-friend-name">Unknown</div>
            <button onclick="openBlockModal()" style="background:none; border:none; color:#666; cursor:pointer;"><i class="fas fa-ban"></i></button>
        </div>
        <div class="chat-messages" id="chat-msgs"></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="modal-input" style="margin:0; padding:10px;" placeholder="Transmission..." onkeypress="handleChatKey(event)">
            <button onclick="sendMessage()" style="background:var(--cyan); border:none; padding:0 15px; border-radius:2px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="social-tabs">
        <button class="tab-btn active" onclick="switchTab('friends')">Allies</button>
        <button class="tab-btn" onclick="switchTab('ranking')">Rank</button>
        <button class="tab-btn" onclick="switchTab('comms')">Add</button>
        <button class="tab-btn" onclick="switchTab('blocked')" style="color:#ff6666;">Ban</button>
    </div>

    <div class="social-body">
        <div id="view-friends" class="social-view active">
            <div id="friends-list"></div>
        </div>
        
        <div id="view-ranking" class="social-view" style="padding:15px;">
            <div id="leaderboard-list"></div>
        </div>

        <div id="view-comms" class="social-view" style="padding:20px;">
            <div style="font-size:0.7rem; color:#666; text-transform:uppercase; margin-bottom:10px;">Establish Link</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="invite-input-tab" class="modal-input" placeholder="ENTER ID" maxlength="16" style="margin:0; font-family:var(--font-mono); text-align:center;">
                <button onclick="sendInvite()" style="background:var(--cyan); border:none; width:50px; cursor:pointer; font-weight:bold;"><i class="fas fa-plus"></i></button>
            </div>
            <p id="invite-msg-tab" style="font-size:0.75rem; text-align:center; min-height:1em; margin:0 0 20px;"></p>
            
            <div style="font-size:0.7rem; color:#666; text-transform:uppercase; margin-bottom:10px; border-top:1px solid #222; padding-top:15px;">Pending Signals</div>
            <div id="requests-list"></div>
        </div>

        <div id="view-blocked" class="social-view">
            <div id="blocked-list"></div>
        </div>
    </div>
</div>

<div id="block-confirm-modal" class="modal">
    <div class="modal-box" style="border-color:var(--danger);">
        <h3 style="color:var(--danger); margin-top:0;">SEVER CONNECTION?</h3>
        <p style="color:#aaa; font-size:0.9rem;">Communication with this entity will be terminated.</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="action-btn" onclick="closeModal('block-confirm-modal')" style="background:transparent; border:1px solid #444; color:#aaa;">Cancel</button>
            <button class="action-btn" onclick="confirmBlockUser()" style="background:var(--danger); color:white;">BLOCK</button>
        </div>
    </div>
</div>

<div id="unblock-confirm-modal" class="modal">
    <div class="modal-box">
        <h3 style="color:var(--cyan); margin-top:0;">RESTORE LINK</h3>
        <p style="color:#aaa; font-size:0.9rem;">Re-establish connection protocols?</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="action-btn" onclick="closeModal('unblock-confirm-modal')" style="background:transparent; border:1px solid #444; color:#aaa;">Cancel</button>
            <button class="action-btn" onclick="confirmUnblockUser()">RESTORE</button>
        </div>
    </div>
</div>

<div id="login-modal" class="modal">
    <div class="modal-box">
        <span onclick="closeModal('login-modal')" style="position:absolute; top:10px; right:15px; color:#666; cursor:pointer; font-size:1.2rem;">×</span>
        <h2 style="color:white; margin-top:0;">IDENTITY VERIFICATION</h2>
        <p style="color:#888; font-size:0.9rem; margin-bottom:25px;">Required for data persistence and classified saves.</p>
        <button onclick="loginGoogle()" style="background:white; color:black; border:none; padding:12px; width:100%; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
    </div>
</div>

<div id="username-modal" class="modal" style="z-index: 7005;">
    <div class="modal-box">
        <h2 style="color:var(--cyan); margin-top:0;">CREATE ALIAS</h2>
        <p style="color:#666; font-size:0.8rem; margin-bottom:15px;">Unique alphanumeric identifier required.</p>
        <input type="text" id="new-username" class="modal-input" placeholder="CODENAME (3-10 CHARS)" maxlength="10">
        <p id="username-error" style="color: var(--danger); font-size: 0.8rem; display: none; margin: 5px 0;"></p>
        <button id="submit-btn" onclick="submitUsername()" class="action-btn">ESTABLISH ID</button>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-box" style="padding:0; border:none; background:transparent; max-width:400px;">
        <span onclick="closeModal('profile-modal')" style="position:absolute; top:-30px; right:0; color:white; cursor:pointer; font-size:1.5rem; opacity:0.7;">×</span>
        <div id="profile-content"></div>
    </div>
</div>

<div id="protocols-modal" class="modal">
    <div class="modal-box large">
        <span onclick="closeModal('protocols-modal')" style="position:absolute; top:15px; right:20px; color:white; cursor:pointer; font-size:1.5rem;">×</span>
        <h2 style="color:var(--cyan); margin-top:0; letter-spacing: 2px;">NEXUS PROTOCOLS</h2>
        <div style="color:#ccc; line-height:1.6; font-size:0.9rem; height:100%;">
            <h3 style="border-bottom:1px solid #333; padding-bottom:5px; margin-top:20px;">1.0 MISSION DIRECTIVE</h3>
            <p>The Scientific Nexus Research Terminal (SNRT) aggregates high-fidelity HTML5 simulations for cognitive reflex testing and physics comprehension. Modules are categorized into Kinetic Action, Structural Physics, and Cognitive Strategy.</p>
            
            <h3 style="border-bottom:1px solid #333; padding-bottom:5px; margin-top:20px;">2.0 NEURAL LINK PRIVACY</h3>
            <p><strong>Authentication:</strong> We use Google Firebase Auth. We only store your public ID and email for profile generation.</p>
            <p><strong>Data:</strong> Chat logs are encrypted in transit. Local storage is used for session stability.</p>
            
            <h3 style="border-bottom:1px solid #333; padding-bottom:5px; margin-top:20px;">3.0 SPONSORED UPLINKS</h3>
            <p>We utilize Google AdSense to maintain server operations. Cookies may be used for ad personalization as per Google's policies.</p>
            
            <p style="text-align:center; margin-top:30px; color:#555;">// END OF LINE //</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, query, where, orderBy, limit, 
        serverTimestamp, writeBatch, collectionGroup, setDoc, getDoc, arrayUnion, arrayRemove 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- 1. SYSTEM INITIALIZATION ---
    function safeInit() {
        const loader = document.getElementById('loader');
        if(loader && !loader.classList.contains('hidden')) {
            loader.classList.add('hidden');
            render(); 
        }
    }
    document.addEventListener("DOMContentLoaded", safeInit);
    setTimeout(safeInit, 3000); // Fallback

    // --- 2. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCrgwoD_IVwlyvUQwDDQj6T772obSOL8So",
        authDomain: "scientificnexus-65c48.firebaseapp.com",
        projectId: "scientificnexus-65c48",
        storageBucket: "scientificnexus-65c48.firebasestorage.app",
        messagingSenderId: "125907587809",
        appId: "1:125907587809:web:d8068604db659fa357dda0",
        measurementId: "G-787GN5V4WT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let userData = null; 
    let activeChatId = null;
    let currentChatUserUid = null;
    let targetUnblockUid = null;
    let chatUnsub = null;
    let friendStatusUnsubs = [];
    let globalMsgListener = null;

    // --- 3. GAME DATABASE ---
    const gameData = [
       { title: "SkillFull Finger", cat: "Physics", url: "https://html5.gamedistribution.com/c7af7f58929a4a3c891ccf1192223a6a/", thumb: "https://img.gamedistribution.com/c7af7f58929a4a3c891ccf1192223a6a-1280x720.jpg" },
       { title: "Football Duel", cat: "Sports & Racing", url: "https://html5.gamedistribution.com/4a9c7ad53f7c48678b3b848390a62daa/", thumb: "https://img.gamedistribution.com/4a9c7ad53f7c48678b3b848390a62daa-1280x720.jpg" },
       { title: "Tap it Away 3D", cat: "Puzzle", url: "https://html5.gamedistribution.com/87cb43c5492049b49b01491248d9ced1/", thumb: "https://img.gamedistribution.com/87cb43c5492049b49b01491248d9ced1-1280x720.jpg" },
       { title: "Zombie Survival", cat: "Action", url: "https://html5.gamedistribution.com/53ad84c4f3b440f2b65d5382fadf731f/", thumb: "https://img.gamedistribution.com/53ad84c4f3b440f2b65d5382fadf731f-1280x720.jpg" },
       { title: "Bar Brawl", cat: "Action", url: "https://html5.gamedistribution.com/f3a9542e779b426799867918b11fd70b/", thumb: "https://img.gamedistribution.com/f3a9542e779b426799867918b11fd70b-1280x720.jpg" },
       { title: "Stick Master", cat: "Strategy", url: "https://html5.gamedistribution.com/a497f71f7ff64128bb9f3d4f7a58dddc/", thumb: "https://img.gamedistribution.com/a497f71f7ff64128bb9f3d4f7a58dddc-512x384.jpg" },
       { title: "Craft Of Wars", cat: "Arcade", url: "https://html5.gamedistribution.com/99b5f30d028d40df825363d98fa5831f/", thumb: "https://img.gamedistribution.com/99b5f30d028d40df825363d98fa5831f-512x512.jpg" },
       { title: "Coe Snake", cat: "Casual", url: "https://html5.gamedistribution.com/b73efc1f47194a4cbb5d0af8b492187b/", thumb: "https://img.gamedistribution.com/b73efc1f47194a4cbb5d0af8b492187b-1280x720.jpg" },
       { title: "Real Cargo Truck", cat: "Simulation", url: "https://html5.gamedistribution.com/1ea2160082d542ce8d9166f63f61d366/", thumb: "https://img.gamedistribution.com/1ea2160082d542ce8d9166f63f61d366-512x384.jpg" },
       { title: "Math vs Bat", cat: "Educational", url: "https://html5.gamedistribution.com/91c70ab32b754af89cd73528ba236d34/", thumb: "https://img.gamedistribution.com/91c70ab32b754af89cd73528ba236d34-512x384.jpeg" },
       { title: "Drift Boss", cat: "Sports & Racing", url: "https://html5.gamedistribution.com/0a8b51e5eaee42e7b4db83ca00afc92e/", thumb: "https://img.gamedistribution.com/0a8b51e5eaee42e7b4db83ca00afc92e-512x384.jpg" },
       { title: "Daily Solitaire", cat: "Casual", url: "https://html5.gamedistribution.com/5e6d0ffd732a496bb5f0dc2a15e88778/", thumb: "https://img.gamedistribution.com/5e6d0ffd732a496bb5f0dc2a15e88778-1280x550.jpeg" },
       { title: "Airport Security", cat: "Casual", url: "https://html5.gamedistribution.com/aff91273917349db8ae9a921954aae5c/", thumb: "https://img.gamedistribution.com/aff91273917349db8ae9a921954aae5c-1280x720.jpg" }
    ];

    // --- 4. RENDER LOGIC ---
    function render() {
        const grid = document.getElementById('game-grid');
        if(!grid) return;
        grid.innerHTML = '';
        gameData.forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    }

    function createCard(g) {
        const div = document.createElement('div');
        div.className = 'card reveal-on-scroll';
        div.innerHTML = `
            <img src="${g.thumb}" class="thumb" loading="lazy" onerror="this.src='https://via.placeholder.com/300x200?text=Signal+Lost'">
            <div class="card-body">
                <h3 class="card-title">${g.title}</h3>
                <span class="card-cat">${g.cat}</span>
            </div>
        `;
        div.onclick = () => openGame(g.url, g.title, g.cat);
        return div;
    }

    function observeElements() {
        if (window.globalObserver) window.globalObserver.disconnect();
        window.globalObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) entry.target.classList.add('reveal');
            });
        }, { threshold: 0.1 }); 
        document.querySelectorAll('.reveal-on-scroll').forEach(el => window.globalObserver.observe(el));
    }

    window.openGame = function(baseUrl, title, cat) {
        const gv = document.getElementById('game-viewer');
        const loader = document.getElementById('game-loader-ui');
        const referrer = encodeURIComponent(window.location.href);
        
        let finalUrl = baseUrl;
        if(baseUrl.includes('via.placeholder')) {
             finalUrl = 'about:blank';
             alert("Simulation data corrupted (Placeholder).");
        } else {
             finalUrl = `${baseUrl}?gd_sdk_referrer_url=${referrer}`;
        }
        
        gv.style.display = 'block'; 
        setTimeout(() => gv.classList.add('active'), 10);
        loader.style.display = 'flex';
        
        const iframe = document.getElementById('game-frame');
        iframe.src = finalUrl;
        iframe.onload = () => { loader.style.display = 'none'; };

        document.getElementById('gv-title').innerText = title;
        document.getElementById('gv-cat').innerText = cat;
    };

    window.closeGame = function() {
        const gv = document.getElementById('game-viewer'); 
        gv.classList.remove('active');
        setTimeout(() => { 
            gv.style.display = 'none'; 
            document.getElementById('game-frame').src = "about:blank"; 
        }, 300);
    };
    
    window.toggleFull = function() {
        const el = document.getElementById('gf-wrapper');
        !document.fullscreenElement ? el.requestFullscreen().catch(e=>{}) : document.exitFullscreen();
    };
    window.goHome = function() { window.scrollTo({ top: 0, behavior: 'smooth' }); };
    
    window.openProtocols = function() { document.getElementById('protocols-modal').classList.add('active'); };
    window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); };

    function showToast(title, message) {
        const container = document.getElementById('nexus-toast-container');
        const toast = document.createElement('div');
        toast.className = 'nexus-toast';
        toast.innerHTML = `<div style="color:var(--cyan)"><i class="fas fa-info-circle"></i></div><div><h4>${title}</h4><p>${message}</p></div>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('active'), 50);
        setTimeout(() => { toast.classList.remove('active'); setTimeout(() => toast.remove(), 500); }, 4000);
    }

    // --- 5. AUTH & USER LOGIC ---
    window.openLoginModal = function() { document.getElementById('login-modal').classList.add('active'); };
    
    window.loginGoogle = function() {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider)
            .then(() => window.closeModal('login-modal'))
            .catch(err => alert("Login Error: " + err.message));
    };
    
    window.logout = function() {
        if (globalMsgListener) globalMsgListener();
        friendStatusUnsubs.forEach(unsub => unsub());
        signOut(auth).then(() => window.location.reload());
    };

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        const container = document.getElementById('auth-container');
        if (user) {
            startHeartbeat();
            initGlobalMessageListener();
            onSnapshot(doc(db, 'users', user.uid), snapshot => {
                if (snapshot.exists()) {
                    userData = snapshot.data();
                    if (!userData.username) document.getElementById('username-modal').classList.add('active');
                    else {
                        if (!userData.commanderId) ensureCommanderId();
                        updateUIWithProfile();
                    }
                    loadSocialData();
                } else {
                    document.getElementById('username-modal').classList.add('active');
                }
            });
        } else {
            container.innerHTML = `<button class="auth-btn" onclick="openLoginModal()"><i class="fas fa-key"></i> ACCESS</button>`;
            document.getElementById('social-fab').style.display = 'none';
        }
    });

    function updateUIWithProfile() {
        if (!currentUser) return;
        const container = document.getElementById('auth-container');
        const displayName = (userData && userData.username) ? userData.username : "Recruit";
        const photo = currentUser.photoURL || "https://via.placeholder.com/32";
        container.innerHTML = `<button class="auth-btn" style="border-color:var(--cyan);" onclick="openProfileModal()"><img src="${photo}" class="user-avatar"><span>${displayName}</span></button>`;
        document.getElementById('social-fab').style.display = 'flex';
    }

    // --- 6. PROFILE & GAMIFICATION (REFACTORED) ---
    window.openProfileModal = function() {
        if (!currentUser) return;
        
        const username = userData?.username || "Unknown";
        const commanderId = userData?.commanderId || "SYNCING...";
        const photo = currentUser.photoURL;
        
        // Calculate Logic
        const xpData = calculateXP(userData.joined);
        
        // Format Join Date
        let joinDateStr = "Unknown";
        if (userData.joined && userData.joined.seconds) {
            joinDateStr = new Date(userData.joined.seconds * 1000).toLocaleDateString();
        }

        const content = document.getElementById('profile-content');
        
        // NEW HTML STRUCTURE (Cyber-Professional)
        content.innerHTML = `
            <div class="pro-profile-card">
                <div class="pro-header">
                    <div class="pro-avatar-container">
                        <img src="${photo}" class="pro-avatar">
                    </div>
                    <div class="pro-identity">
                        <h2>${username}</h2>
                        <span class="pro-tag">Class ${xpData.level} Researcher</span>
                    </div>
                </div>

                <div class="pro-stats-grid">
                    <div class="stat-box" onclick="copyCode('${commanderId}')" style="cursor:pointer" title="Click to Copy">
                        <span class="stat-label">Commander ID</span>
                        <span class="stat-value"><i class="fas fa-copy" style="font-size:0.7rem; margin-right:5px;"></i>${commanderId}</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Joined</span>
                        <span class="stat-value">${joinDateStr}</span>
                    </div>
                </div>

                <div class="pro-xp-section">
                    <div class="xp-header">
                        <span>XP Progress</span>
                        <span>${Math.floor(xpData.current)} / ${xpData.next}</span>
                    </div>
                    <div class="xp-track">
                        <div class="xp-progress" style="width:${xpData.percent}%"></div>
                    </div>
                </div>

                <div class="pro-actions">
                    <button class="disconnect-btn" onclick="logout()">
                        <i class="fas fa-power-off"></i> Disconnect
                    </button>
                </div>
            </div>
        `;
        document.getElementById('profile-modal').classList.add('active');
    };

    function calculateXP(joinedTimestamp) {
        if (!joinedTimestamp) return { current:0, next:500, level:1, percent:0 };
        const joined = joinedTimestamp.seconds ? joinedTimestamp.seconds * 1000 : Date.now();
        const days = Math.max(1, Math.floor((Date.now() - joined) / (1000 * 60 * 60 * 24)));
        const totalXP = (days * 50) + 100;
        const level = Math.floor(totalXP / 500) + 1;
        const nextLevelXP = level * 500;
        const currentLevelXP = (level - 1) * 500;
        const percent = ((totalXP - currentLevelXP) / 500) * 100;
        return { current: totalXP, next: nextLevelXP, level, percent };
    }

    function generateCommanderId() { return `${Math.floor(10000000 + Math.random() * 90000000)}${Math.floor(10000000 + Math.random() * 90000000)}`; }

    async function ensureCommanderId() {
        if (!userData || userData.commanderId) return;
        const newId = generateCommanderId();
        const batch = writeBatch(db);
        batch.set(doc(db, "friend_codes", newId), { uid: currentUser.uid, username: userData.username || "Unknown" });
        batch.update(doc(db, "users", currentUser.uid), { commanderId: newId });
        await batch.commit();
    }
    
    window.copyCode = function(code) { navigator.clipboard.writeText(code); showToast("System", "ID copied to clipboard."); };

    window.submitUsername = async function() {
        const input = document.getElementById('new-username');
        const errorMsg = document.getElementById('username-error');
        const btn = document.getElementById('submit-btn');
        const username = input.value.trim();
        
        if (!/^[a-zA-Z0-9]{3,10}$/.test(username)) { 
            errorMsg.innerText = "Error: Alphanumeric, 3-10 chars only."; errorMsg.style.display = 'block'; return; 
        }
        
        btn.disabled = true; btn.innerText = "PROCESSING...";
        try {
            const check = await getDoc(doc(db, 'usernames', username));
            if (check.exists() && check.data().uid !== currentUser.uid) { 
                errorMsg.innerText = "Alias taken."; errorMsg.style.display = 'block'; btn.disabled = false; return; 
            }
            const batch = writeBatch(db);
            const cId = userData?.commanderId || generateCommanderId();
            
            if (!userData?.commanderId) batch.set(doc(db, 'friend_codes', cId), { uid: currentUser.uid, username: username });
            batch.set(doc(db, 'usernames', username), { uid: currentUser.uid });
            batch.set(doc(db, 'users', currentUser.uid), {
                username: username, commanderId: cId, uid: currentUser.uid,
                photoURL: currentUser.photoURL, email: currentUser.email,
                joined: userData?.joined || serverTimestamp(),
                friends: userData?.friends || [], blocked: userData?.blocked || []
            }, { merge: true });
            
            await batch.commit(); window.location.reload();
        } catch (e) { errorMsg.innerText = "Error: " + e.message; btn.disabled = false; }
    };

    // --- 7. SOCIAL LOGIC & CHAT (PRESERVED) ---
    function initGlobalMessageListener() {
        if (!currentUser) return;
        if (globalMsgListener) globalMsgListener();
        const q = query(collectionGroup(db, 'messages'), where('receiverId', '==', currentUser.uid), where('read', '==', false));
        globalMsgListener = onSnapshot(q, (snap) => {
            const count = snap.size;
            const badge = document.getElementById('global-badge');
            badge.innerText = count >= 100 ? "100+" : count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        });
    }

    function loadSocialData() {
        if (!currentUser) return;
        const q = query(collection(db, 'friend_requests'), where('toUid', '==', currentUser.uid));
        onSnapshot(q, snap => {
            const list = document.getElementById('requests-list');
            let html = '';
            snap.forEach(docSnap => { 
                const d = docSnap.data();
                html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #333;">
                    <span style="color:white; font-size:0.8rem;">${d.fromName}</span>
                    <button onclick="acceptRequest('${docSnap.id}', '${d.fromUid}', '${d.fromName}')" style="background:var(--success); border:none; color:black; border-radius:2px; padding:4px 10px; cursor:pointer; font-size:0.7rem;">ACCEPT</button>
                </div>`;
            });
            list.innerHTML = html || '<div style="text-align:center; color:#666; font-size:0.75rem;">No incoming data.</div>';
        });
        if(userData) { renderFriends(userData.friends || []); renderBlocked(userData.blocked || []); }
    }

    function loadLeaderboard() {
        const div = document.getElementById('leaderboard-list');
        const q = query(collection(db, 'users'), orderBy('joined', 'asc'), limit(10));
        import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(module => {
            module.getDocs(q).then(snap => {
                let html = '';
                let rank = 1;
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `<div style="display:flex; padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.85rem;">
                        <span style="color:var(--cyan); width:30px; font-weight:bold;">#${rank++}</span>
                        <span style="flex:1; color:#ddd;">${d.username || 'Unknown'}</span>
                        <span style="color:#666; font-size:0.7rem;">LVL ${calculateXP(d.joined).level}</span>
                    </div>`;
                });
                div.innerHTML = html;
            });
        });
    }

    function renderFriends(arr) {
        const list = document.getElementById('friends-list');
        friendStatusUnsubs.forEach(u => u()); friendStatusUnsubs = [];
        if (!arr.length) { list.innerHTML = '<div style="text-align:center; color:#666; margin-top:30px; font-size:0.8rem;">No allies connected.</div>'; return; }
        list.innerHTML = ''; 
        const unique = [...new Map(arr.map(item => [item.uid, item])).values()];
        unique.forEach(f => {
            const div = document.createElement('div'); div.className = 'friend-item';
            div.innerHTML = `
                <img src="https://ui-avatars.com/api/?name=${f.username}&background=00f2ff&color=000" style="width:32px; height:32px; border-radius:50%; border:1px solid #333;">
                <div style="flex:1;">
                    <div style="color:white; font-size:0.85rem;">${f.username}</div>
                    <div style="color:#666; font-size:0.7rem;" id="status-${f.uid}">Offline</div>
                </div>
                <i class="far fa-comment-dots" style="color:#666"></i>
            `;
            div.onclick = () => window.openChat(f.uid, f.username);
            list.appendChild(div);
            friendStatusUnsubs.push(onSnapshot(doc(db, 'users', f.uid), d => {
                if(d.exists()) {
                    const data = d.data();
                    const lastSeen = data.lastSeen ? (data.lastSeen.seconds * 1000) : 0;
                    const isOnline = (Date.now() - lastSeen) < 60000;
                    const el = document.getElementById(`status-${f.uid}`);
                    if(el) {
                         el.innerHTML = isOnline ? 'Online' : 'Offline';
                         el.style.color = isOnline ? 'var(--success)' : '#666';
                    }
                }
            }));
        });
    }

    function renderBlocked(arr) {
        const list = document.getElementById('blocked-list');
        list.innerHTML = arr.length ? '' : '<div style="text-align:center; color:#666; margin-top:30px; font-size:0.8rem;">No blocked entities.</div>';
        arr.forEach(b => {
             list.innerHTML += `<div style="display:flex; padding:15px; border-bottom:1px solid #333; align-items:center;">
                <div style="flex:1; color:#888;">${b.username}</div>
                <button onclick="openUnblockModal('${b.uid}')" style="background:transparent; border:1px solid var(--cyan); color:var(--cyan); border-radius:2px; padding:4px 10px; cursor:pointer; font-size:0.7rem;">RESTORE</button>
             </div>`;
        });
    }

    function startHeartbeat() {
        const beat = () => { if(currentUser) updateDoc(doc(db, "users", currentUser.uid), { lastSeen: serverTimestamp() }).catch(()=>{}); };
        beat(); setInterval(beat, 45000); 
    }

    window.sendInvite = async function() {
        const input = document.getElementById('invite-input-tab');
        const msg = document.getElementById('invite-msg-tab');
        const code = input.value.trim();
        if (code.length < 5) return;
        try {
            const codeDoc = await getDoc(doc(db, 'friend_codes', code));
            if (!codeDoc.exists()) { msg.innerText = "Target invalid."; msg.style.color = 'var(--danger)'; return; }
            const targetUid = codeDoc.data().uid;
            if (targetUid === currentUser.uid || userData.friends.some(f=>f.uid===targetUid)) { msg.innerText = "Already linked."; return; }
            await addDoc(collection(db, 'friend_requests'), { fromUid: currentUser.uid, fromName: userData.username, toUid: targetUid, timestamp: serverTimestamp() });
            msg.innerText = "Signal sent."; msg.style.color = 'var(--success)'; input.value = '';
        } catch (e) { msg.innerText = "Error."; }
    };

    window.acceptRequest = async function(reqId, fromUid, fromName) {
        const batch = writeBatch(db);
        batch.update(doc(db, 'users', currentUser.uid), { friends: arrayUnion({ uid: fromUid, username: fromName }) });
        batch.update(doc(db, 'users', fromUid), { friends: arrayUnion({ uid: currentUser.uid, username: userData.username }) });
        batch.delete(doc(db, 'friend_requests', reqId));
        await batch.commit();
    };

    window.openChat = function(friendUid, friendName) {
        currentChatUserUid = friendUid;
        document.getElementById('chat-friend-name').innerText = friendName;
        document.getElementById('chat-interface').classList.add('open');
        activeChatId = [currentUser.uid, friendUid].sort().join('_');
        const msgContainer = document.getElementById('chat-msgs');
        if(chatUnsub) chatUnsub();
        
        const q = query(collection(db, 'chats', activeChatId, 'messages'), orderBy('timestamp', 'asc'), limit(50));
        chatUnsub = onSnapshot(q, (snapshot) => {
            msgContainer.innerHTML = '';
            const batch = writeBatch(db);
            let hasUpdates = false;
            snapshot.docs.forEach(docSnap => {
                const d = docSnap.data();
                const div = document.createElement('div');
                div.className = `msg ${d.senderId === currentUser.uid ? 'mine' : 'theirs'}`;
                div.innerText = d.text;
                msgContainer.appendChild(div);
                if(d.receiverId === currentUser.uid && d.read === false) {
                    batch.update(docSnap.ref, { read: true }); hasUpdates = true;
                }
            });
            msgContainer.scrollTop = msgContainer.scrollHeight;
            if(hasUpdates) batch.commit().catch(e => console.log("Batch Error", e));
        });
    };

    window.closeChat = function() { document.getElementById('chat-interface').classList.remove('open'); if (chatUnsub) chatUnsub(); };
    
    window.sendMessage = async function() {
        const input = document.getElementById('chat-input');
        const txt = input.value.trim();
        if (!txt || !activeChatId || !currentChatUserUid) return;
        await addDoc(collection(db, 'chats', activeChatId, 'messages'), { 
            text: txt, senderId: currentUser.uid, receiverId: currentChatUserUid, read: false, timestamp: serverTimestamp() 
        });
        input.value = '';
    };
    
    window.handleChatKey = function(e) { if (e.key === 'Enter') window.sendMessage(); };
    
    window.toggleSocialPanel = function() { 
        if (!currentUser) { alert("Login required."); return; } 
        document.getElementById('social-panel').classList.toggle('active'); 
    };
    
    window.switchTab = function(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.social-view').forEach(v => v.classList.remove('active'));
        const idx = tab==='friends'?0 : tab==='ranking'?1 : tab==='comms'?2 : 3;
        document.querySelectorAll('.tab-btn')[idx].classList.add('active');
        document.getElementById(`view-${tab}`).classList.add('active');
        if(tab === 'ranking') loadLeaderboard();
    };
    
    window.filterCat = function(cat) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        const grid = document.getElementById('game-grid'); grid.innerHTML = '';
        (cat === 'All' ? gameData : gameData.filter(g => g.cat === cat)).forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    };
    
    window.filterGames = function() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const grid = document.getElementById('game-grid'); grid.innerHTML = '';
        gameData.filter(g => g.title.toLowerCase().includes(q)).forEach(g => grid.appendChild(createCard(g)));
        observeElements();
    };
    
    window.openBlockModal = function() { document.getElementById('block-confirm-modal').classList.add('active'); };
    window.openUnblockModal = function(uid) { targetUnblockUid = uid; document.getElementById('unblock-confirm-modal').classList.add('active'); };
    
    window.confirmBlockUser = async function() {
        const friendName = document.getElementById('chat-friend-name').innerText;
        const batch = writeBatch(db);
        batch.update(doc(db, 'users', currentUser.uid), { 
            friends: arrayRemove({ uid: currentChatUserUid, username: friendName }), 
            blocked: arrayUnion({ uid: currentChatUserUid, username: friendName }) 
        });
        await batch.commit();
        window.closeModal('block-confirm-modal'); 
        window.closeChat();
    };
    
    window.confirmUnblockUser = function() { 
        if(!targetUnblockUid) return; 
        const blockedObj = userData.blocked.find(b => b.uid === targetUnblockUid);
        if(blockedObj) updateDoc(doc(db, 'users', currentUser.uid), { blocked: arrayRemove(blockedObj) });
        window.closeModal('unblock-confirm-modal');
    };
</script>
</body>
</html>